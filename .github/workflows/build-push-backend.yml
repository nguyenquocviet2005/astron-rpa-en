name: Build and Push Astron RPA Backend Services

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to registry'
        required: false
        default: true
        type: boolean
      services:
        description: 'Services to build (comma-separated: ai-service,openapi-service,resource-service,robot-service)'
        required: false
        default: 'ai-service,openapi-service,resource-service,robot-service'
        type: string

concurrency:
  group: build-push-backend-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  attestations: write
  id-token: write

env:
  REGISTRY_GHCR: ghcr.io

jobs:
  # ============================================================================
  # Stage 1: Project Detection and Metadata
  # ============================================================================
  detect-and-prepare:
    name: üîç Detection & Metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      should-push: ${{ steps.meta.outputs.should-push }}
      platforms: ${{ steps.meta.outputs.platforms }}
      services: ${{ steps.meta.outputs.services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract metadata
        id: meta
        run: |
          # Determine version based on trigger
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="latest"
          fi

          # Determine if should push (always true for releases, configurable for manual dispatch)
          SHOULD_PUSH="false"
          if [[ "${{ github.event_name }}" == "release" ]]; then
            SHOULD_PUSH="true"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.push_images }}" == "true" ]]; then
            SHOULD_PUSH="true"
          fi

          # Set platforms (multi-arch builds for better compatibility)
          PLATFORMS="linux/amd64,linux/arm64"

          # Determine services to build
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.services }}" ]]; then
            SERVICES="${{ github.event.inputs.services }}"
          else
            SERVICES="ai-service,openapi-service,resource-service,robot-service"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "should-push=$SHOULD_PUSH" >> $GITHUB_OUTPUT
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
          echo "services=$SERVICES" >> $GITHUB_OUTPUT

          echo "üè∑Ô∏è Version: $VERSION"
          echo "üì§ Should push: $SHOULD_PUSH"
          echo "üèóÔ∏è Platforms: $PLATFORMS"
          echo "üîß Services: $SERVICES"

  # ============================================================================
  # Stage 2: Build Backend Services (Parallel Jobs)
  # ============================================================================
  build-ai-service:
    name: ü§ñ Build AI Service
    runs-on: ubuntu-latest
    needs: detect-and-prepare
    if: contains(needs.detect-and-prepare.outputs.services, 'ai-service')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: needs.detect-and-prepare.outputs.should-push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/ai-service
          tags: |
            type=raw,value=${{ needs.detect-and-prepare.outputs.version }}
            ${{ github.event_name == 'release' && 'type=raw,value=latest' || '' }}

      - name: Build and push AI Service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/ai-service/Dockerfile
          platforms: ${{ needs.detect-and-prepare.outputs.platforms }}
          push: ${{ needs.detect-and-prepare.outputs.should-push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.detect-and-prepare.outputs.version }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_id }}
          cache-from: type=gha,scope=ai-service
          cache-to: type=gha,scope=ai-service,mode=max

  build-openapi-service:
    name: üåê Build OpenAPI Service
    runs-on: ubuntu-latest
    needs: detect-and-prepare
    if: contains(needs.detect-and-prepare.outputs.services, 'openapi-service')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: needs.detect-and-prepare.outputs.should-push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/openapi-service
          tags: |
            type=raw,value=${{ needs.detect-and-prepare.outputs.version }}
            ${{ github.event_name == 'release' && 'type=raw,value=latest' || '' }}

      - name: Build and push OpenAPI Service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/openapi-service/Dockerfile
          platforms: ${{ needs.detect-and-prepare.outputs.platforms }}
          push: ${{ needs.detect-and-prepare.outputs.should-push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.detect-and-prepare.outputs.version }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_id }}
          cache-from: type=gha,scope=openapi-service
          cache-to: type=gha,scope=openapi-service,mode=max

  build-resource-service:
    name: üì¶ Build Resource Service
    runs-on: ubuntu-latest
    needs: detect-and-prepare
    if: contains(needs.detect-and-prepare.outputs.services, 'resource-service')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: needs.detect-and-prepare.outputs.should-push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/resource-service
          tags: |
            type=raw,value=${{ needs.detect-and-prepare.outputs.version }}
            ${{ github.event_name == 'release' && 'type=raw,value=latest' || '' }}

      - name: Build and push Resource Service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/resource-service/Dockerfile
          platforms: ${{ needs.detect-and-prepare.outputs.platforms }}
          push: ${{ needs.detect-and-prepare.outputs.should-push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.detect-and-prepare.outputs.version }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_id }}
          cache-from: type=gha,scope=resource-service
          cache-to: type=gha,scope=resource-service,mode=max

  build-robot-service:
    name: ü§ñ Build Robot Service
    runs-on: ubuntu-latest
    needs: detect-and-prepare
    if: contains(needs.detect-and-prepare.outputs.services, 'robot-service')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: needs.detect-and-prepare.outputs.should-push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/robot-service
          tags: |
            type=raw,value=${{ needs.detect-and-prepare.outputs.version }}
            ${{ github.event_name == 'release' && 'type=raw,value=latest' || '' }}

      - name: Build and push Robot Service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/robot-service/Dockerfile
          platforms: ${{ needs.detect-and-prepare.outputs.platforms }}
          push: ${{ needs.detect-and-prepare.outputs.should-push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.detect-and-prepare.outputs.version }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_id }}
          cache-from: type=gha,scope=robot-service
          cache-to: type=gha,scope=robot-service,mode=max

  # ============================================================================
  # Stage 3: Summary and Notifications
  # ============================================================================
  build-summary:
    name: üìä Build Summary
    runs-on: ubuntu-latest
    needs:
      - detect-and-prepare
      - build-ai-service
      - build-openapi-service
      - build-resource-service
      - build-robot-service
    if: always()
    steps:
      - name: Generate build summary
        run: |
          echo "=== üê≥ astron RPA Backend Services Docker Build Summary ==="
          echo ""
          echo "üîç Project Detection: ${{ needs.detect-and-prepare.result }}"
          echo "üìä Version: ${{ needs.detect-and-prepare.outputs.version }}"
          echo "üì§ Push to Registry: ${{ needs.detect-and-prepare.outputs.should-push }}"
          echo "üèóÔ∏è Target Platforms: ${{ needs.detect-and-prepare.outputs.platforms }}"
          echo "üîß Services: ${{ needs.detect-and-prepare.outputs.services }}"
          echo ""

          echo "üê≥ Docker Build Results:"
          echo "  ü§ñ AI Service: ${{ needs.build-ai-service.result }}"
          echo "  üåê OpenAPI Service: ${{ needs.build-openapi-service.result }}"
          echo "  üì¶ Resource Service: ${{ needs.build-resource-service.result }}"
          echo "  ü§ñ Robot Service: ${{ needs.build-robot-service.result }}"
          echo ""

          # Count successful builds
          SUCCESS_COUNT=0
          TOTAL_COUNT=0

          # Check each service based on what was requested
          if [[ "${{ needs.detect-and-prepare.outputs.services }}" == *"ai-service"* ]]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            [[ "${{ needs.build-ai-service.result }}" == "success" ]] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          fi
          if [[ "${{ needs.detect-and-prepare.outputs.services }}" == *"openapi-service"* ]]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            [[ "${{ needs.build-openapi-service.result }}" == "success" ]] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          fi
          if [[ "${{ needs.detect-and-prepare.outputs.services }}" == *"resource-service"* ]]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            [[ "${{ needs.build-resource-service.result }}" == "success" ]] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          fi
          if [[ "${{ needs.detect-and-prepare.outputs.services }}" == *"robot-service"* ]]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            [[ "${{ needs.build-robot-service.result }}" == "success" ]] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          fi

          echo "üìä Build Success Rate: $SUCCESS_COUNT/$TOTAL_COUNT services built successfully"

          if [[ "${{ needs.detect-and-prepare.outputs.should-push }}" == "true" ]]; then
            echo ""
            echo "üéØ Published Images:"
            if [[ "${{ needs.build-ai-service.result }}" == "success" ]]; then
              echo "  ü§ñ ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/ai-service:${{ needs.detect-and-prepare.outputs.version }}"
              if [[ "${{ github.event_name }}" == "release" ]]; then
                echo "  ü§ñ ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/ai-service:latest"
              fi
            fi
            if [[ "${{ needs.build-openapi-service.result }}" == "success" ]]; then
              echo "  üåê ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/openapi-service:${{ needs.detect-and-prepare.outputs.version }}"
              if [[ "${{ github.event_name }}" == "release" ]]; then
                echo "  üåê ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/openapi-service:latest"
              fi
            fi
            if [[ "${{ needs.build-resource-service.result }}" == "success" ]]; then
              echo "  üì¶ ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/resource-service:${{ needs.detect-and-prepare.outputs.version }}"
              if [[ "${{ github.event_name }}" == "release" ]]; then
                echo "  üì¶ ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/resource-service:latest"
              fi
            fi
            if [[ "${{ needs.build-robot-service.result }}" == "success" ]]; then
              echo "  ü§ñ ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/robot-service:${{ needs.detect-and-prepare.outputs.version }}"
              if [[ "${{ github.event_name }}" == "release" ]]; then
                echo "  ü§ñ ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/robot-service:latest"
              fi
            fi
          fi

          if [[ "$SUCCESS_COUNT" == "$TOTAL_COUNT" && "$TOTAL_COUNT" -gt 0 ]]; then
            echo ""
            echo "‚úÖ üéâ All requested backend services built successfully!"
            if [[ "${{ needs.detect-and-prepare.outputs.should-push }}" == "true" ]]; then
              echo "üöÄ Images are now available in GitHub Container Registry"
            else
              echo "üì¶ Images built locally (not pushed to registry)"
            fi
          elif [[ "$TOTAL_COUNT" -eq 0 ]]; then
            echo ""
            echo "‚ö†Ô∏è No services were requested to be built"
          else
            echo ""
            echo "‚ùå üö® Some Docker builds failed - check individual job results"
            exit 1
          fi

          # Additional info for manual workflow dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo ""
            echo "üîß Manual Workflow Dispatch Summary:"
            echo "  Trigger: ${{ github.actor }}"
            echo "  Ref: ${{ github.ref }}"
            echo "  Build Type: latest (based on current code)"
            echo "  Push Images: ${{ github.event.inputs.push_images }}"
            echo "  Services: ${{ github.event.inputs.services }}"
          fi
